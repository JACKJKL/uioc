!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.uioc=e.uioc||{})}(this,function(e){"use strict";function t(e){return Object.prototype.toString.call(e)===l}function n(e,t,r,o,i){var u=e.module;"function"!=typeof e.creator&&u&&(r[u]=r[u]||[],r[u].push(e)),t.processConfig(e.id);var a=null;if(o){if(o.checkForCircular(e.id)){var s=e.id+" has circular dependencies ";throw new m(s,e)}o.addData(e),a=o.appendChild(new d)}for(var c=(i=i||e.argDeps.concat(e.propDeps).concat(e.setterDeps||[])).length-1;c>-1;--c)t.hasComponent(i[c])&&n(t.getComponentConfig(i[c]),t,r,a);return r}function r(){return"function"==typeof define&&define.amd&&"function"==typeof C.require?require:"undefined"!=typeof module&&module&&"exports"in module?function(e,t){return t.apply(void 0,f(e.map(function(e){return require(e)})))}:function(e,t){return t.apply(void 0,f(e.map(function(e){return C[e]})))}}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},s=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},c=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},f=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},l=Object.prototype.toString.call({}),p={hasOwn:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},addToSet:function(e,t){-1===e.indexOf(t)&&e.push(t)},isObject:t,isPromise:function(e){return e&&"object"===(void 0===e?"undefined":o(e))&&"function"==typeof e.then},hasRef:function(e){return t(e)&&"string"==typeof e.$ref},warn:function(){"undefined"!=typeof console&&Function.prototype.apply.call(console.warn,console,arguments)}},h=Symbol("store"),y=Symbol("getInstance"),v=function(){function e(t){i(this,e),this.context=t,this[h]=Object.create(null)}return u(e,[{key:"createInstance",value:function(e){var t=this;if(!e)return Promise.resolve(null);switch(e.scope){case"singleton":var n=e.id;return n in this[h]||(this[h][n]=this[y](e).then(function(e){return t[h][n]=e})),Promise.resolve(this[h][n]);case"transient":return this[y](e);case"static":return Promise.resolve(e.creator)}}},{key:"injectArgs",value:function(e){var t=this,n=e.args;return Promise.all(n.map(function(e){return p.hasRef(e)?t.context.getComponent(e.$ref):e}))}},{key:"dispose",value:function(){var e=this[h];for(var t in e){var n=e[t];n&&"function"==typeof n.dispose&&n.dispose()}this[h]=null}},{key:y,value:function(e){return this.injectArgs(e).then(function(t){return e.creator.apply(e,f(t))})}}]),e}(),d=function(){function e(){i(this,e),this.data=[],this.children=[],this.parent=null}return u(e,[{key:"appendChild",value:function(e){return e.parent=this,this.children.push(e),e}},{key:"checkForCircular",value:function(e){var t=this.parent;if(null!==t)for(var n=t.data.length-1;n>-1;--n)return t.data[n].id&&t.data[n].id===e?t.data[n]:t.checkForCircular(e);return null}},{key:"addData",value:function(e,t){return(!t||!this.checkForCircular(e.id))&&(this.data.push(e),!0)}}]),e}(),m=function(e){function t(e,n){i(this,t);var r=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.component=n,r}return s(t,e),u(t,[{key:"print",value:function(){if("undefined"!=typeof console){var e;(e=console).warn.apply(e,arguments)}}}]),t}(Error),g=function(){function e(t,n){i(this,e),this.amdLoader=r(),this.context=t,this.skipCheckingCircularDep=n}return u(e,[{key:"setLoaderFunction",value:function(e){this.amdLoader=e}},{key:"resolveDependentModules",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2],o=this.skipCheckingCircularDep?null:new d;return n(e,this.context,t,o,r)}},{key:"loadModuleMap",value:function(e){var t=this,n=Object.keys(e);return n.length?new Promise(function(r){t.amdLoader(n,function(){for(var t=arguments.length,o=Array(t),i=0;i<t;i++)o[i]=arguments[i];o.forEach(function(t,r){var o=n[r];e[o].forEach(function(e){"function"!=typeof e.creator&&(e.creator=e.creator||t)})}),r()})}):Promise.resolve()}},{key:"wrapCreator",value:function(e,t){var n=e.creator;return e.isFactory||"static"===e.scope||(e.creator=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n,[null].concat(t)))}),Promise.resolve(e)}}]),e}(),C=Function("return this")(),b=function(){function e(){i(this,e)}return u(e,[{key:"onContainerInit",value:function(e,t){return t}},{key:"onAddComponent",value:function(e,t,n){return n}},{key:"onGetComponent",value:function(e,t,n){return n}},{key:"beforeCreateInstance",value:function(e,t,n){return Promise.resolve(n)}},{key:"afterCreateInstance",value:function(e,t,n){return Promise.resolve(n)}},{key:"onContainerDispose",value:function(e){}},{key:"name",get:function(){throw new Error("need to be implement")}}]),e}(),k=Symbol("cache"),O=function(e){function t(){i(this,t);var e=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e[k]=Object.create(null),e}return s(t,b),u(t,[{key:"name",get:function(){return"import"}}],[{key:"has",value:function(e){return p.isObject(e)&&"string"==typeof e.$import}},{key:"transformConfig",value:function(e,n){var r=n.args,o=null,i=r.reduce(function(i,u,a){return t.has(u)&&(o=t.createAnonymousConfig(e,u,n.id+"-$arg."+a+"."),r[a]={$ref:o},i.push(o)),i},[]),u=n.properties;for(var a in u)t.has(u[a])&&(o=t.createAnonymousConfig(e,u[a],n.id+"-$prop."+a+"."),u[a]={$ref:o},i.push(o));return i}},{key:"createAnonymousConfig",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2],r=t.$import;if(!e.hasComponent(r))throw new Error("$import "+r+" component, but it is not exist, please check!!");var o=e.getComponentConfig(r);return t.id=(-1!==n.indexOf("^uioc-")?"":"^uioc-")+n,t.$import=void 0,e.addComponent(t.id,a({},o,t)),t.id}}]),u(t,[{key:"onGetComponent",value:function(e,n,r){return this[k][n]?r:(this[k][n]=t.transformConfig(e,r),r)}}]),t}(),P=/^set[A-Z]/,_="set".length,j=Symbol("cache"),w=function(e){function t(){i(this,t);var e=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e[j]=Object.create(null),e}return s(t,b),u(t,[{key:"name",get:function(){return"auto"}}],[{key:"getPropertyFromSetter",value:function(e,t){var n=null;return P.test(e)&&"function"==typeof t.value&&(n=e.charAt(_).toLowerCase()+e.slice(_+1)),n}},{key:"setProperty",value:function(e,t,n){e["set"+t.charAt(0).toUpperCase()+t.slice(1)](n)}}]),u(t,[{key:"afterCreateInstance",value:function(e,n,r){var o=this.resolveDependencies(e,n,r);return o.length?e.getComponent(o).then(function(e){return e.forEach(function(e,n){return t.setProperty(r,o[n],e)}),r}):Promise.resolve(r)}},{key:"resolveDependencies",value:function(e,n,r){if(this[j][n])return this[j][n];var o=e.getComponentConfig(n)||{};if(!o.auto)return this[j][n]=[],[];for(var i=o.properties||{},u=[],a=Object.create(null),s=r;s;s=Object.getPrototypeOf(s))!function(n){Object.getOwnPropertyNames(n).forEach(function(r){if(!a[r]){a[r]=!0;var o=Object.getOwnPropertyDescriptor(n,r);(r=t.getPropertyFromSetter(r,o))&&!p.hasOwn(i,r)&&e.hasComponent(r)&&u.push(r)}})}(s);return this[j][n]=u,o.setterDeps=u,u}}]),t}(),I=Symbol("cache"),D=function(e){function t(){i(this,t);var e=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e[I]=Object.create(null),e}return s(t,b),u(t,[{key:"name",get:function(){return"property"}}],[{key:"getSetter",value:function(e){if(p.isObject(e)&&"string"==typeof e.$setter)return e.$setter}},{key:"setProperty",value:function(e,t,n,r){if(r)return e[r](n);var o="set"+t.charAt(0).toUpperCase()+t.slice(1);"function"==typeof e[o]?e[o](n):e[t]=n}}]),u(t,[{key:"afterCreateInstance",value:function(e,n,r){if(!e.hasComponent(n))return Promise.resolve(r);var o=e.getComponentConfig(n),i=this.resolveDependencies(e,n),u=o.properties;return e.getComponent(i).then(function(e){for(var n in u){var o=u[n],a=p.hasRef(o)?e[i.indexOf(o.$ref)]:o;t.setProperty(r,n,a,t.getSetter(o))}return r})}},{key:"resolveDependencies",value:function(e,t){if(this[I][t])return this[I][t];var n=this[I][t]=[],r=e.getComponentConfig(t),o=r.properties;for(var i in o){var u=o[i];p.hasRef(u)&&n.push(u.$ref)}return r.propDeps=n,n}}]),t}(),A=Symbol("cache"),S=function(e){function t(){i(this,t);var e=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e[A]=Object.create(null),e}return s(t,b),u(t,[{key:"name",get:function(){return"list"}}],[{key:"has",value:function(e){return p.isObject(e)&&e.$list instanceof Array}}]),u(t,[{key:"onContainerInit",value:function(e,t){return e.addComponent(this.constructor.LIST_ID,this.constructor.LIST_COMPONENT_CONFIG),t}},{key:"onGetComponent",value:function(e,n,r){if(this[A][n])return r;var o=this.constructor,i=o.has,u=o.LIST_ID;r.args=r.args.map(function(e){return i(e)?{$import:u,args:e.$list}:e});var a=r.properties;for(var s in a){var c=a[s];t.has(c)&&(a[s]={$import:u,args:c.$list})}return this[A][n]=!0,r}}]),t}();S.LIST_COMPONENT_CONFIG={creator:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t},isFactory:!0},S.LIST_ID=Date.now()+"_list";var $=Symbol("cache"),x=function(e){function t(){i(this,t);var e=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e[$]=Object.create(null),e}return s(t,b),u(t,[{key:"name",get:function(){return"map"}}],[{key:"has",value:function(e){return p.isObject(e)&&p.isObject(e.$map)}}]),u(t,[{key:"onContainerInit",value:function(e,t){return e.addComponent(this.constructor.MAP_ID,this.constructor.MAP_COMPONENT_CONFIG),t}},{key:"onGetComponent",value:function(e,n,r){if(this[$][n])return r;var o=this.constructor,i=o.has,u=o.MAP_ID;r.args=r.args.map(function(e){return i(e)?{$import:u,properties:e.$map}:e});var a=r.properties;for(var s in a){var c=a[s];t.has(c)&&(a[s]={$import:u,properties:c.$map})}return r}}]),t}();x.MAP_COMPONENT_CONFIG={creator:Object,isFactory:!0},x.MAP_ID=(new Date).getTime()+"_map";var F=function(e){function t(){return i(this,t),c(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,b),u(t,[{key:"onContainerInit",value:function(e,t){return e.addComponent(this.constructor.AOP_ID,this.constructor.AOP_COMPONENT_CONFIG),t}},{key:"canProxy",value:function(e,t){if(!("aopConfig"in e))return!1;var n=e.aopConfig.proxyTarget;return(void 0===n?"object":n)===t}},{key:"proxyAop",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o="class"===t?"createClassProxy":"createObjectProxy",i=this.constructor.AOP_ID;return e.getComponent(i).then(function(e){return r.reduce(function(t,n){var r=n.matcher,i=n.advices;return e[o](t,r,i)},n)})}},{key:"beforeCreateInstance",value:function(e,t,n){var r=e.getComponentConfig(t)||{};return this.canProxy(r,"class")?this.proxyAop(e,"class",r.creator,r.aopConfig.advisors).then(function(e){return r.creator=e}).then(function(){return n}):Promise.resolve(n)}},{key:"afterCreateInstance",value:function(e,t,n){var r=e.getComponentConfig(t)||{};return this.canProxy(r,"object")?this.proxyAop(e,"object",n,r.aopConfig.advisors):Promise.resolve(n)}},{key:"name",get:function(){return"aop"}}]),t}();F.AOP_COMPONENT_CONFIG={module:"uaop",scope:"static"},F.AOP_ID=Symbol("internalAop");var E=Symbol("collection"),N=Symbol("components"),M=Symbol("createComponent"),T=Symbol("createInstance"),G=Symbol("loader"),L=Symbol("injector"),R={},q=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this[N]=Object.create(null),this[E]=new B([new S,new x,new O,new F,new D,new w]),this[E].addPlugins(t.plugins),this[G]=new g(this,!!t.skipCheckingCircularDep),this[L]=new v(this),t=this[E].onContainerInit(this,t),this.initConfig(t)}return u(e,[{key:"initConfig",value:function(e){e.loader&&this.setLoaderFunction(e.loader),this.addComponent(e.components||{})}},{key:"addComponent",value:function(e,t){if("object"!==(void 0===e?"undefined":o(e))){if(this.hasComponent(e))throw new Error(String(e)+" has been added!");this[N][e]=this[M].call(this,e,t)}else for(var n in e)this.addComponent(n,e[n])}},{key:"getComponent",value:function(e){var t=this;if(e instanceof Array)return Promise.all(e.map(function(e){return t.getComponent(e)}));var n=Object.create(null);if(!this.hasComponent(e))return e=String(e),Promise.reject(new Error("`"+e+"` has not been added to the Ioc"));var r=this.getComponentConfig(e);this.processConfig(e);try{n=this[G].resolveDependentModules(r,n,r.argDeps)}catch(e){return Promise.reject(e)}return this[G].loadModuleMap(n).then(function(){return t[T](e)})}},{key:"hasComponent",value:function(e){return!!this[N][e]}},{key:"getComponentConfig",value:function(e){return e?this[N][e]:this[N]}},{key:"setLoaderFunction",value:function(e){this[G].setLoaderFunction(e)}},{key:"dispose",value:function(){this[E].onContainerDispose(this),this[L].dispose(),this[N]=null}},{key:"addPlugins",value:function(e,t){this[E].addPlugins(e,t)}},{key:"getPlugins",value:function(){return this[E].getPlugins()}},{key:"removePlugin",value:function(e){return this[E].removePlugin(e)}},{key:"processConfig",value:function(e){var t=this.getComponentConfig(e);if(t=this[E].onGetComponent(this,e,t),this[N][e]=t,!t.argDeps)for(var n=t.argDeps=[],r=t.args,o=r.length-1;o>-1;--o)p.hasRef(r[o])&&n.push(r[o].$ref)}},{key:M,value:function(e,t){return t=this[E].onAddComponent(this,e,t),a({id:e,args:[],properties:{},argDeps:null,propDeps:null,setterDeps:null,scope:"transient",creator:null,module:void 0,isFactory:!1,auto:!1,instance:null},t)}},{key:T,value:function(e){var t=this;return this[E].beforeCreateInstance(this,e).then(function(n){if(n===R){var r=t.hasComponent(e)?t.getComponentConfig(e):null;return t[G].wrapCreator(r).then(function(e){return t[L].createInstance(e)})}return n}).then(function(n){return t[E].afterCreateInstance(t,e,n)})}}]),e}(),U=Symbol("plugins"),B=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];i(this,e),this[U]=t}return u(e,[{key:"onContainerInit",value:function(e,t){return this[U].reduce(function(t,n){return n.onContainerInit(e,t)},t)}},{key:"onAddComponent",value:function(e,t,n){return this[U].reduce(function(n,r){return r.onAddComponent(e,t,n)},n)}},{key:"onGetComponent",value:function(e,t,n){return this[U].reduce(function(n,r){return r.onGetComponent(e,t,n)},n)}},{key:"beforeCreateInstance",value:function(e,t){return this[U].reduce(function(n,r){return n.then(function(n){return Promise.resolve(r.beforeCreateInstance(e,t,n))})},Promise.resolve(R))}},{key:"afterCreateInstance",value:function(e,t,n){return this[U].reduce(function(n,r){return n.then(function(n){var o=r.afterCreateInstance(e,t,n);return p.isPromise(o)?o:Promise.resolve(n)})},Promise.resolve(n))}},{key:"onContainerDispose",value:function(e){this[U].forEach(function(t){return t.onContainerDispose(e)})}},{key:"addPlugins",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this[U].length;(e=this[U]).splice.apply(e,[n,0].concat(f(t)))}},{key:"getPlugins",value:function(){return this[U].slice(0)}},{key:"removePlugin",value:function(e){return"number"!=typeof e&&(e=-1===(e=this[U].indexOf(e))?this[U].length:e),!!this[U].splice(e,1).length}}]),e}();e.IoC=q,e.BasePlugin=b,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=bundle.js.map
